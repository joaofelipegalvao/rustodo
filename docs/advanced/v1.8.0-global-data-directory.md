# v1.8.0 - Global Data Directory

**ðŸŽ¯ Goal:** Move task data from current working directory to OS-appropriate global location

**ðŸ“¦ The Problem We're Solving:**

**Before v1.8.0 - Directory-dependent data:**

```bash
# User creates tasks in ~/projects
cd ~/projects
todo add "Project task"
todo list
# Shows: 1 task

# User moves to ~/documents
cd ~/documents
todo list
# Shows: No tasks! ðŸ˜•

# Different directory = different todos.json file
~/projects/todos.json    # Has "Project task"
~/documents/todos.json   # Empty or different tasks
```

**Problems:**

âŒ **Fragmented task lists** - Tasks scattered across directories  
âŒ **Lost tasks** - Easy to forget which directory has which tasks  
âŒ **Inconsistent state** - Running from different locations shows different data  
âŒ **Non-standard behavior** - Real CLIs don't work this way  
âŒ **Backup complexity** - Must back up multiple `todos.json` files  

**After v1.8.0 - Global data location:**

```bash
# Tasks stored in single OS-appropriate location
# Linux:   ~/.config/todo-cli/todos.json
# macOS:   ~/Library/Application Support/todo-cli/todos.json
# Windows: %APPDATA%\todo-cli\todos.json

# User creates tasks anywhere
cd ~/projects
todo add "Project task"

# User moves to different directory
cd ~/documents
todo list
# Shows: 1 task âœ“

# Same data, regardless of working directory!
```

**Benefits:**

âœ… **Single source of truth** - One task list across all directories  
âœ… **Standard behavior** - Matches professional CLI applications  
âœ… **Easy backups** - One known location to back up  
âœ… **XDG compliance** - Follows platform conventions  
âœ… **Portable** - Works correctly on Linux, macOS, and Windows  

---

## ðŸ§  Key Concepts

### Platform-Specific Configuration Directories

**Operating systems have standard locations for application data:**

| Platform | Standard Location | Example Path |
|----------|-------------------|--------------|
| **Linux** | `~/.config/` | `~/.config/todo-cli/todos.json` |
| **macOS** | `~/Library/Application Support/` | `~/Library/Application Support/todo-cli/todos.json` |
| **Windows** | `%APPDATA%\` | `C:\Users\Name\AppData\Roaming\todo-cli\todos.json` |

**Why these locations?**

- **Linux (XDG)**: Follows [XDG Base Directory Specification](https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html)
- **macOS**: Apple's standard for app support files
- **Windows**: Microsoft's roaming profile directory

### The `directories` Crate

**Purpose:** Cross-platform abstraction for system directories

```rust
use directories::ProjectDirs;
```

**What it provides:**

- Automatic platform detection
- Standard directory paths
- Configuration directory creation
- Consistent API across platforms

**Example usage:**

```rust
if let Some(proj_dirs) = ProjectDirs::from("", "", "todo-cli") {
    let data_dir = proj_dirs.data_dir();
    // Linux:   /home/user/.config/todo-cli
    // macOS:   /Users/user/Library/Application Support/todo-cli
    // Windows: C:\Users\user\AppData\Roaming\todo-cli
}
```

### Implementation Details

**New function: `get_date_file_path()`**

```rust
fn get_date_file_path() -> Result<PathBuf> {
    let proj_dirs = ProjectDirs::from("", "", "todo-cli")
        .context("Failed to determine project directories")?;

    let data_dir = proj_dirs.data_dir();

    // Create directory if it doesn't exist
    if !data_dir.exists() {
        fs::create_dir_all(data_dir)
            .context(format!("Failed to create data directory at {}", data_dir.display()))?;
    }

    Ok(data_dir.join("todos.json"))
}
```

**Breaking it down:**

1. **Get project directories:**

   ```rust
   ProjectDirs::from("", "", "todo-cli")
   ```

   - First parameter: Qualifier (organization domain, unused here)
   - Second parameter: Organization (unused here)
   - Third parameter: Application name (`"todo-cli"`)
   - Returns `Option<ProjectDirs>` - `None` if platform unsupported

2. **Get data directory:**

   ```rust
   let data_dir = proj_dirs.data_dir();
   ```

   - Returns platform-specific config directory
   - Type: `&Path` (reference to path)

3. **Create directory if missing:**

   ```rust
   if !data_dir.exists() {
       fs::create_dir_all(data_dir)?;
   }
   ```

   - `create_dir_all()` creates parent directories if needed
   - Like `mkdir -p` on Unix
   - Idempotent - safe to call multiple times

4. **Join filename to path:**

   ```rust
   Ok(data_dir.join("todos.json"))
   ```

   - Combines directory path + filename
   - Returns full path to data file

### Updated `load_tasks()` Function

**Before (v1.7.0):**

```rust
fn load_tasks() -> Result<Vec<Task>> {
    match fs::read_to_string("todos.json") {  // â† Hardcoded filename
        Ok(content) => serde_json::from_str(&content)
            .context("Failed to parse todos.json - file may be corrupted"),
        Err(e) if e.kind() == std::io::ErrorKind::NotFound => Ok(Vec::new()),
        Err(e) => Err(e).context(format!(
            "Failed to read todos.json from current directory: {}",
            std::env::current_dir().unwrap_or_default().display()
        )),
    }
}
```

**After (v1.8.0):**

```rust
fn load_tasks() -> Result<Vec<Task>> {
    let path = get_date_file_path()?;  // â† Get platform-specific path

    match fs::read_to_string(&path) {
        Ok(content) => serde_json::from_str(&content)
            .context(format!("Failed to parse {} - file may be corrupted", path.display())),
        Err(e) if e.kind() == std::io::ErrorKind::NotFound => Ok(Vec::new()),
        Err(e) => Err(e).context(format!(
            "Failed to read {} from {}",
            path.file_name().unwrap_or_default().to_string_lossy(),
            path.parent().unwrap_or_else(|| Path::new("")).display()
        )),
    }
}
```

**Key changes:**

1. **Dynamic path resolution:**

   ```rust
   let path = get_date_file_path()?;
   ```

   - Path determined at runtime based on OS
   - Directory created automatically if needed

2. **Better error messages:**

   ```rust
   .context(format!("Failed to parse {} - file may be corrupted", path.display()))
   ```

   - Shows actual file path in error
   - User knows exactly which file has the problem

3. **Path decomposition in errors:**

   ```rust
   path.file_name().unwrap_or_default().to_string_lossy()
   path.parent().unwrap_or_else(|| Path::new("")).display()
   ```

   - Separates filename from directory in error messages
   - Clearer feedback about what failed

### Updated `save_tasks()` Function

**Before (v1.7.0):**

```rust
fn save_tasks(tasks: &[Task]) -> Result<()> {
    let json = serde_json::to_string_pretty(tasks)
        .context("Failed to serialize tasks to JSON")?;

    fs::write("todos.json", json)  // â† Hardcoded filename
        .context("Failed to write to todos.json - check file permissions")?;

    Ok(())
}
```

**After (v1.8.0):**

```rust
fn save_tasks(tasks: &[Task]) -> Result<()> {
    let path = get_date_file_path()?;  // â† Get platform-specific path

    let json = serde_json::to_string_pretty(tasks)
        .context("Failed to serialize tasks to JSON")?;

    fs::write(&path, json)
        .context(format!("Failed to write to {} - check file permissions", path.display()))?;

    Ok(())
}
```

**Changes:**

- Uses `get_date_file_path()` instead of hardcoded `"todos.json"`
- Error messages include actual file path
- Consistent with `load_tasks()` pattern

### New Command: `info`

**Purpose:** Show user where their data is stored

```rust
Commands::Info => {
    let path = get_date_file_path()?;
    let exists = path.exists();

    println!("\n{}\n", "Todo-List Information".bold());
    println!("{} {}", "Data file:".dimmed(), path.display());
    println!(
        "{} {}",
        "Status:".dimmed(),
        if exists {
            "exists âœ“".green()
        } else {
            "not created yet".yellow()
        }
    );

    if exists {
        let metadata = fs::metadata(&path)?;
        let size = metadata.len();
        println!("{} {} bytes", "Size:".dimmed(), size);
    }

    println!();
}
```

**Output example (Linux):**

```bash
$ todo info

Todo-List Information

Data file: /home/user/.config/todo-cli/todos.json
Status: exists âœ“
Size: 1245 bytes
```

**Output example (macOS):**

```bash
$ todo info

Todo-List Information

Data file: /Users/user/Library/Application Support/todo-cli/todos.json
Status: not created yet
```

**Why this command is important:**

1. **Discovery** - Users can find where their data lives
2. **Debugging** - Helps troubleshoot file permission issues
3. **Backup** - Users know exactly what to back up
4. **Transparency** - No hidden data locations

### Updated `clear` Command

**Before (v1.7.0):**

```rust
Commands::Clear => {
    if fs::metadata("todos.json").is_ok() {  // â† Hardcoded filename
        fs::remove_file("todos.json")?;
        println!("{}", "âœ“ All tasks have been removed".red().bold());
    } else {
        println!("No tasks to remove");
    }
}
```

**After (v1.8.0):**

```rust
Commands::Clear => {
    let path = get_date_file_path()?;  // â† Dynamic path

    if path.exists() {
        fs::remove_file(&path).context(format!("Failed to remove {}", path.display()))?;
        println!("{}", "âœ“ All tasks have been removed".red().bold());
    } else {
        println!("No tasks to remove");
    }
}
```

**Changes:**

- Uses dynamic path instead of hardcoded filename
- Better error context with actual file path
- Consistent with other file operations

---

## ðŸ“Š Migration from v1.7.0

### Automatic Migration

**The CLI handles migration automatically:**

1. **First run after upgrade:**
   - CLI calls `get_date_file_path()`
   - Creates config directory if needed
   - Looks for `todos.json` in new location
   - If not found, returns empty task list

2. **Old data in current directory:**
   - Old `todos.json` files remain in place
   - **Not** automatically migrated
   - User must manually copy if needed

### Manual Migration Steps

**If you have existing tasks to migrate:**

```bash
# 1. Find where your old todos.json file is
find ~ -name "todos.json" -type f 2>/dev/null

# 2. Find new data directory
todo info
# Shows: Data file: /home/user/.config/todo-cli/todos.json

# 3. Copy old file to new location (Linux/macOS)
cp /path/to/old/todos.json ~/.config/todo-cli/todos.json

# 4. Verify migration worked
todo list
# Should show your old tasks

# 5. (Optional) Remove old files
rm /path/to/old/todos.json
```

**Windows migration:**

```powershell
# 1. Find new data directory
todo info
# Shows: Data file: C:\Users\Name\AppData\Roaming\todo-cli\todos.json

# 2. Copy old file
copy C:\path\to\old\todos.json %APPDATA%\todo-cli\todos.json

# 3. Verify
todo list
```

### Why Not Automatic Migration?

**Design decision:** Don't automatically migrate old files

**Reasons:**

1. **Multiple old files** - Which one to migrate?

   ```
   ~/projects/todos.json
   ~/work/todos.json
   ~/personal/todos.json
   ```

   No way to know which is the "canonical" version

2. **User choice** - Let user decide which data to keep
3. **No data loss** - Old files remain untouched
4. **Explicit action** - User consciously chooses to migrate

---

## ðŸŽ¯ Best Practices

### Backup Strategy

**Before v1.8.0:**

```bash
# Must backup todos.json from every directory used
~/projects/todos.json
~/work/todos.json
~/personal/todos.json
```

**After v1.8.0:**

```bash
# Single file to backup
~/.config/todo-cli/todos.json  # Linux
~/Library/Application Support/todo-cli/todos.json  # macOS
%APPDATA%\todo-cli\todos.json  # Windows

# Simple backup script (Linux/macOS)
cp ~/.config/todo-cli/todos.json ~/backups/todos-$(date +%Y%m%d).json

# Automated daily backup (Linux cron)
0 0 * * * cp ~/.config/todo-cli/todos.json ~/backups/todos-$(date +\%Y\%m\%d).json
```

### Finding Your Data

**Use the `info` command:**

```bash
$ todo info

Todo-List Information

Data file: /home/user/.config/todo-cli/todos.json
Status: exists âœ“
Size: 1245 bytes
```

**Direct file access:**

```bash
# View raw JSON (Linux/macOS)
cat ~/.config/todo-cli/todos.json

# Edit manually (Linux/macOS)
nano ~/.config/todo-cli/todos.json

# View in GUI (Linux)
xdg-open ~/.config/todo-cli/

# View in Finder (macOS)
open ~/Library/Application\ Support/todo-cli/

# View in Explorer (Windows)
explorer %APPDATA%\todo-cli
```

### Syncing Across Machines

**Using cloud storage (Dropbox/Google Drive):**

```bash
# 1. Move data to cloud folder
mv ~/.config/todo-cli/todos.json ~/Dropbox/todo-cli/todos.json

# 2. Create symlink
ln -s ~/Dropbox/todo-cli/todos.json ~/.config/todo-cli/todos.json

# 3. Repeat on other machines
# Now all machines share the same task list via Dropbox
```

**Using Git:**

```bash
# 1. Initialize repo in config directory
cd ~/.config/todo-cli
git init
git add todos.json
git commit -m "Initial tasks"

# 2. Push to remote
git remote add origin git@github.com:user/todo-tasks.git
git push -u origin main

# 3. On other machines
git clone git@github.com:user/todo-tasks.git ~/.config/todo-cli
```

---

## ðŸ”§ Technical Implementation Notes

### `PathBuf` vs `Path`

**Understanding Rust path types:**

```rust
// PathBuf - owned, mutable path (like String)
let path_buf: PathBuf = data_dir.join("todos.json");

// Path - borrowed, immutable path (like &str)
let path: &Path = &path_buf;
```

**In our implementation:**

```rust
fn get_date_file_path() -> Result<PathBuf> {
    // Returns owned PathBuf so caller can move/store it
    Ok(data_dir.join("todos.json"))
}
```

**Why `PathBuf`?**

- **Owned** - Caller can store it
- **Composable** - Can be modified/extended
- **Standard** - Matches Rust path idioms

### Directory Creation with `create_dir_all()`

```rust
fs::create_dir_all(data_dir)?;
```

**What it does:**

```bash
# Creates all parent directories if they don't exist
# Like 'mkdir -p' on Unix

# If this doesn't exist:
/home/user/.config/todo-cli/

# create_dir_all() creates:
/home/user/.config/          # If needed
/home/user/.config/todo-cli/ # Always
```

**Error handling:**

- Returns `io::Result<()>`
- Fails if:
  - Path exists but is a file, not directory
  - Insufficient permissions
  - Disk full
  - Path contains null bytes (invalid)

**Idempotency:**

```rust
// Safe to call multiple times
fs::create_dir_all(data_dir)?;  // Creates directory
fs::create_dir_all(data_dir)?;  // No error - directory already exists
```

### Platform Detection at Runtime

**How `directories` crate detects platform:**

```rust
// At compile time, Rust sets cfg flags:
#[cfg(target_os = "linux")]     // Linux
#[cfg(target_os = "macos")]     // macOS
#[cfg(target_os = "windows")]   // Windows

// directories crate uses these internally
impl ProjectDirs {
    pub fn from(qualifier: &str, organization: &str, application: &str) -> Option<Self> {
        #[cfg(target_os = "linux")]
        {
            // Use XDG_CONFIG_HOME or ~/.config
        }

        #[cfg(target_os = "macos")]
        {
            // Use ~/Library/Application Support
        }

        #[cfg(target_os = "windows")]
        {
            // Use %APPDATA%
        }
    }
}
```

**Single binary works on all platforms:**

- No runtime checks needed
- Platform-specific code compiled in
- Zero overhead
- Type-safe

### Error Context Chain

**Rich error messages with full context:**

```rust
let path = get_date_file_path()
    .context("Failed to determine data file path")?;

fs::read_to_string(&path)
    .context(format!("Failed to read {} - file may be corrupted", path.display()))?;
```

**Error chain example:**

```bash
Error: Failed to parse /home/user/.config/todo-cli/todos.json - file may be corrupted
Caused by: EOF while parsing a value at line 8 column 3
```

**Layers of context:**

1. **Application level** - "Failed to parse todos.json"
2. **System level** - "EOF while parsing"
3. **Location** - "at line 8 column 3"

---

## ðŸ§ª Testing the Feature

### Verify Platform-Specific Paths

```bash
# Test that info command shows correct path
todo info

# Expected output (Linux):
# Data file: /home/user/.config/todo-cli/todos.json

# Expected output (macOS):
# Data file: /Users/user/Library/Application Support/todo-cli/todos.json

# Expected output (Windows):
# Data file: C:\Users\user\AppData\Roaming\todo-cli\todos.json
```

### Verify Directory Creation

```bash
# Remove config directory (Linux)
rm -rf ~/.config/todo-cli

# Run any command
todo add "Test task"

# Verify directory was created
ls -la ~/.config/todo-cli/
# Should show todos.json
```

### Verify Working Directory Independence

```bash
# Create task in one directory
cd ~/projects
todo add "Project task"

# List from different directory
cd ~/documents
todo list
# Should show "Project task"

# Remove from yet another directory
cd /tmp
todo remove 1
# Should work

# Verify from original directory
cd ~/projects
todo list
# Should show: No tasks
```

### Verify File Persistence

```bash
# Add tasks
todo add "Task 1"
todo add "Task 2"

# Find the actual file
todo info
# Note the path

# Verify file exists
cat $(todo info | grep "Data file:" | cut -d' ' -f3)
# Should show JSON with 2 tasks

# Restart shell, run again
todo list
# Should still show 2 tasks
```

---

## ðŸ“š Learning Outcomes

After implementing v1.8.0, you understand:

1. **Platform conventions** - OS-specific config directories
2. **Cross-platform development** - Using crates like `directories`
3. **Path manipulation** - `PathBuf`, `Path`, `join()`, `display()`
4. **Directory creation** - `create_dir_all()` and its semantics
5. **User experience** - Info commands for transparency
6. **Migration strategies** - Manual vs automatic migration
7. **Idempotent operations** - Safe to call repeatedly
8. **Error context** - Rich, layered error messages

---

## ðŸ”— Resources

- [Code v1.8.0](https://github.com/joaofelipegalvao/todo-cli/tree/v1.8.0)
- [Full diff](https://github.com/joaofelipegalvao/todo-cli/compare/v1.7.0...v1.8.0)
- [directories crate docs](https://docs.rs/directories/)
- [XDG Base Directory Specification](https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html)
- [Rust PathBuf documentation](https://doc.rust-lang.org/std/path/struct.PathBuf.html)

---

## Next Steps

**This architecture is now production-ready!** Future enhancements could include:

- **Cloud sync** - Automatic backup to cloud services
- **Multiple profiles** - Switch between work/personal task lists
- **Import/export** - Migrate between different todo apps
- **Encrypted storage** - Password-protected task files
- **Remote storage** - Store on remote server/database

**The foundation is solid** - all future features benefit from the standardized, platform-aware data storage.

---

**ðŸŽ‰ Your tasks are now properly managed like a professional CLI application!**
